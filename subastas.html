<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMERS | Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 pb-20">
    <nav class="p-6 bg-white border-b flex justify-between items-center sticky top-0 z-50">
        <h2 class="text-xl font-black italic">LUMERS</h2>
        <div id="user" class="text-xs font-bold bg-slate-100 px-3 py-1 rounded-full"></div>
    </nav>

    <main class="p-6 max-w-xl mx-auto">
        <input type="text" id="buscador" placeholder="üîç Buscar ciudad o producto..." class="w-full p-4 rounded-2xl border-none shadow-sm mb-6">
        <div id="lista" class="space-y-4"></div>
    </main>

    <button id="btnAbrir" class="fixed bottom-24 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl text-3xl z-40">+</button>

    <div id="modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end">
        <div class="bg-white w-full rounded-t-[3rem] p-8 animate-bounce-short">
            <h3 class="text-xl font-bold mb-4">Nuevo Env√≠o</h3>
            <div class="space-y-3">
                <input id="fRuta" type="text" placeholder="Ruta (Ej: C√≥rdoba a Mendoza)" class="w-full p-4 bg-slate-100 rounded-xl">
                <input id="fProd" type="text" placeholder="¬øQu√© env√≠as?" class="w-full p-4 bg-slate-100 rounded-xl">
                <input id="fPrecio" type="number" placeholder="Precio $" class="w-full p-4 bg-slate-100 rounded-xl">
                <button id="btnGuardar" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">Publicar</button>
                <button id="btnCerrar" class="w-full text-slate-400 py-2">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDWQG6zKK2CDsnHASgE2jtO3DEnU2RsHw",
            authDomain: "lumers-d1d36.firebaseapp.com",
            projectId: "lumers-d1d36",
            storageBucket: "lumers-d1d36.firebasestorage.app",
            messagingSenderId: "798769127070",
            appId: "1:798769127070:web:6b591851e4c5c62758258f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let datos = [];

        onAuthStateChanged(auth, (u) => {
            if (!u) window.location.replace("index.html");
            else {
                document.getElementById('user').innerText = u.displayName;
                cargar();
            }
        });

        function cargar() {
            onSnapshot(query(collection(db, "subastas"), orderBy("fecha", "desc")), (snap) => {
                datos = snap.docs.map(d => ({id: d.id, ...d.data()}));
                dibujar(datos);
            });
        }

        function dibujar(lista) {
            const div = document.getElementById('lista');
            div.innerHTML = "";
            lista.forEach(i => {
                div.innerHTML += `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                    <div class="flex justify-between mb-2"><span class="text-[10px] font-black uppercase text-blue-600">üìç ${i.ruta}</span><span class="font-bold">$${i.precio}</span></div>
                    <h4 class="font-bold text-slate-800">${i.producto}</h4>
                    <button onclick="window.open('https://wa.me/5491122334455?text=Me+interesa+el+envio+de+${i.producto}')" class="w-full mt-4 bg-slate-900 text-white py-3 rounded-xl text-xs font-bold">Contactar WhatsApp</button>
                </div>`;
            });
        }

        // Buscador
        document.getElementById('buscador').oninput = (e) => {
            const t = e.target.value.toLowerCase();
            dibujar(datos.filter(x => x.ruta.toLowerCase().includes(t) || x.producto.toLowerCase().includes(t)));
        };

        // Modal
        const mod = document.getElementById('modal');
        document.getElementById('btnAbrir').onclick = () => mod.classList.remove('hidden');
        document.getElementById('btnCerrar').onclick = () => mod.classList.add('hidden');
        document.getElementById('btnGuardar').onclick = async () => {
            const r = document.getElementById('fRuta').value, p = document.getElementById('fProd').value, pr = document.getElementById('fPrecio').value;
            if(r && p && pr) {
                await addDoc(collection(db, "subastas"), { ruta: r, producto: p, precio: Number(pr), fecha: serverTimestamp() });
                mod.classList.add('hidden');
            }
        };
    </script>
</body>
</html>
