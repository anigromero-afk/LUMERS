<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat | Lumers Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; }
        .chat-bubble-me {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border-radius: 1.5rem 1.5rem 0 1.5rem;
        }
        .chat-bubble-them {
            background: white;
            color: #1e293b;
            border-radius: 1.5rem 1.5rem 1.5rem 0;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <nav class="bg-white px-6 py-4 flex items-center gap-4 shadow-sm">
        <a href="Subasta.html" class="text-slate-400 text-xl">‚Üê</a>
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-xl">üë§</div>
            <div>
                <h2 class="font-black text-slate-800 leading-none">Coordinaci√≥n de Env√≠o</h2>
                <span class="text-[10px] text-green-500 font-bold uppercase tracking-widest">En l√≠nea ahora</span>
            </div>
        </div>
    </nav>

    <main id="chatBox" class="flex-1 overflow-y-auto p-6 space-y-4">
        </main>

    <div class="glass-input p-4 pb-8">
        <form id="chatForm" class="max-w-md mx-auto flex gap-2">
            <input type="text" id="msgInput" placeholder="Escribe un mensaje..." 
                class="flex-1 bg-slate-100 border-none rounded-2xl px-5 py-4 font-medium focus:ring-2 focus:ring-blue-500 outline-none">
            <button type="submit" class="bg-blue-600 text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                üöÄ
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDWQG6zKK2CDsnHASgE2jtO3DEnU2RsHw",
            authDomain: "lumers-d1d36.firebaseapp.com",
            projectId: "lumers-d1d36",
            storageBucket: "lumers-d1d36.firebasestorage.app",
            messagingSenderId: "798769127070",
            appId: "1:798769127070:web:6b591851e4c5c62758258f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userActual = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userActual = user;
                cargarMensajes();
            } else {
                window.location.href = "index.html";
            }
        });

        function cargarMensajes() {
            const q = query(collection(db, "chats"), orderBy("fecha", "asc"));
            onSnapshot(q, (snapshot) => {
                const chatBox = document.getElementById('chatBox');
                chatBox.innerHTML = '';
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const esMio = msg.uid === userActual.uid;
                    
                    chatBox.innerHTML += `
                        <div class="flex ${esMio ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] px-5 py-3 shadow-sm ${esMio ? 'chat-bubble-me' : 'chat-bubble-them'}">
                                <p class="text-sm font-medium">${msg.texto}</p>
                                <span class="text-[9px] opacity-50 block mt-1">${msg.nombre}</span>
                            </div>
                        </div>
                    `;
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        document.getElementById('chatForm').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msgInput');
            if (!input.value.trim()) return;

            await addDoc(collection(db, "chats"), {
                texto: input.value,
                uid: userActual.uid,
                nombre: userActual.displayName,
                fecha: serverTimestamp()
            });

            input.value = '';
        };
    </script>
</body>
</html>
