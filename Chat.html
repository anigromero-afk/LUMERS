<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensajer√≠a | Lumers</title>
    <script src="https://cdn.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .chat-container { height: calc(100vh - 160px); }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="index.html" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">P</div>
                <div>
                    <h2 class="font-bold text-slate-800">Soporte Lumers / Portador</h2>
                    <span class="text-xs text-green-500 font-medium">‚óè En l√≠nea</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4">
        <div id="chatBox" class="chat-container overflow-y-auto space-y-4 mb-4 p-2">
            
            <div class="flex items-end gap-2 max-w-[80%]">
                <div class="bg-white border border-slate-200 p-4 rounded-2xl rounded-bl-none shadow-sm">
                    <p class="text-sm text-slate-700">¬°Hola! He visto tu env√≠o de la laptop. ¬øTienes las dimensiones exactas de la caja? üì¶</p>
                    <span class="text-[10px] text-slate-400 mt-1 block">10:42 AM</span>
                </div>
            </div>

            <div class="flex items-end gap-2 max-w-[80%] ml-auto flex-row-reverse">
                <div class="bg-blue-600 p-4 rounded-2xl rounded-br-none shadow-md">
                    <p class="text-sm text-white">¬°Hola! S√≠, mide 32x22x2 cm. Pesa muy poco. ¬øPodr√≠as llevarla en tu equipaje de mano?</p>
                    <span class="text-[10px] text-blue-200 mt-1 block">10:45 AM</span>
                </div>
            </div>

        </div>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-4">
            <div class="max-w-4xl mx-auto flex gap-2">
                <button class="p-3 bg-slate-100 rounded-xl text-slate-500 hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
                <input type="text" placeholder="Escribe un mensaje..." class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                <button class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
            </div>
        </div>
    </main>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    projectId: "lumers-web-81346186",
    authDomain: "lumers-web-81346186.firebaseapp.com",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Obtener el ID del paquete de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const envioId = urlParams.get('id');
  const contenedorMensajes = document.getElementById('mensajesChat');

  onAuthStateChanged(auth, (user) => {
    if (!user) return window.location.href = "index.html";

    // 1. Escuchar mensajes en tiempo real
    const q = query(collection(db, `envios/${envioId}/mensajes`), orderBy("fecha", "asc"));
    
    onSnapshot(q, (snapshot) => {
      contenedorMensajes.innerHTML = '';
      snapshot.forEach((doc) => {
        const msg = doc.data();
        const esMio = msg.usuarioId === user.uid;
        
        contenedorMensajes.innerHTML += `
          <div class="flex ${esMio ? 'justify-end' : 'justify-start'} mb-4">
            <div class="${esMio ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-800'} px-4 py-2 rounded-2xl max-w-[80%] shadow-sm">
              <p class="text-xs opacity-75 font-bold">${msg.nombre}</p>
              <p>${msg.texto}</p>
            </div>
          </div>
        `;
        // Auto-scroll al √∫ltimo mensaje
        contenedorMensajes.scrollTop = contenedorMensajes.scrollHeight;
      });
    });

    // 2. Funci√≥n para enviar mensaje
    window.enviarMensaje = async () => {
      const input = document.getElementById('inputMensaje');
      if (!input.value.trim()) return;

      await addDoc(collection(db, `envios/${envioId}/mensajes`), {
        texto: input.value,
        nombre: user.displayName,
        usuarioId: user.uid,
        fecha: serverTimestamp()
      });

      input.value = '';
    };
  });
</script>

</body>
</html>

