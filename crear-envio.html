<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publicar Env√≠o | Lumers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .glass-input { background: white; border: 2px solid #e2e8f0; border-radius: 1.5rem; padding: 1rem 1.5rem; transition: all 0.3s ease; width: 100%; outline: none; }
        .glass-input:focus { border-color: #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .bottom-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border-radius: 2.5rem; }
        #preview { width: 100%; height: 200px; object-cover: cover; border-radius: 2rem; display: none; margin-bottom: 1rem; }
    </style>
</head>
<body class="pb-32">

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md px-6 py-5 border-b border-slate-100 flex items-center gap-4">
        <a href="subasta.html" class="text-2xl">‚Üê</a>
        <h1 class="text-xl font-black text-slate-900 tracking-tighter italic">NUEVO ENV√çO</h1>
    </nav>

    <main class="max-w-md mx-auto px-6 pt-8">
        <form id="formEnvio" class="space-y-6">
            
            <div class="space-y-2">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Imagen del Paquete</p>
                <img id="preview" src="">
                <label class="block w-full bg-blue-50 border-2 border-dashed border-blue-200 p-8 rounded-[2rem] text-center cursor-pointer hover:bg-blue-100 transition-colors">
                    <span class="text-blue-600 font-bold text-sm">üì∏ Tocar para subir foto</span>
                    <input type="file" id="fotoInput" accept="image/*" class="hidden" required>
                </label>
            </div>

            <div class="space-y-4">
                <input type="text" id="nombre" placeholder="¬øQu√© env√≠as? (Ej: Laptop, Sofa)" class="glass-input font-bold" required>
                
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="valor" placeholder="Pago ($)" class="glass-input font-bold" required>
                    <input type="text" id="peso" placeholder="Peso (kg)" class="glass-input font-bold">
                </div>

                <input type="text" id="ruta" placeholder="Ruta (Ej: Madrid -> Barcelona)" class="glass-input font-bold" required>
                
                <textarea id="descripcion" placeholder="Notas adicionales (fragilidad, horario...)" class="glass-input font-medium h-32"></textarea>
            </div>

            <button type="submit" id="btnPublicar" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black uppercase tracking-widest shadow-2xl hover:bg-blue-600 transition-all flex justify-center items-center gap-2">
                <span>Publicar Env√≠o</span>
                <span id="spin" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
            </button>
        </form>
    </main>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bottom-nav px-8 py-4 flex justify-between items-center shadow-2xl">
        <a href="index.html" class="text-white opacity-40 text-xl">üè†</a>
        <a href="subasta.html" class="text-white opacity-40 text-xl">üåç</a>
        <a href="crear-envio.html" class="bg-blue-600 p-4 rounded-2xl shadow-lg -translate-y-2 text-white font-bold text-2xl">+</a>
        <a href="perfil.html" class="text-white opacity-40 text-xl">üë§</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDWQG6zKK2CDsnHASgE2jtO3DEnU2RsHw",
            authDomain: "lumers-d1d36.firebaseapp.com",
            projectId: "lumers-d1d36",
            storageBucket: "lumers-d1d36.firebasestorage.app",
            messagingSenderId: "798769127070",
            appId: "1:798769127070:web:6b591851e4c5c62758258f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) currentUser = user;
            else window.location.href = "index.html";
        });

        // Vista previa de imagen
        document.getElementById('fotoInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (f) => {
                    document.getElementById('preview').src = f.target.result;
                    document.getElementById('preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        // Procesar Formulario
        document.getElementById('formEnvio').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnPublicar');
            const spin = document.getElementById('spin');
            
            btn.disabled = true;
            spin.classList.remove('hidden');

            try {
                const file = document.getElementById('fotoInput').files[0];
                let fotoUrl = "";

                if (file) {
                    const storageRef = ref(storage, `envios/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    fotoUrl = await getDownloadURL(storageRef);
                }

                await addDoc(collection(db, "envios"), {
                    nombre: document.getElementById('nombre').value,
                    valor: document.getElementById('valor').value,
                    ruta: document.getElementById('ruta').value,
                    descripcion: document.getElementById('descripcion').value,
                    foto: fotoUrl,
                    usuarioId: currentUser.uid,
                    usuarioNombre: currentUser.displayName,
                    usuarioFoto: currentUser.photoURL,
                    estado: "Disponible",
                    fecha: serverTimestamp(),
                    transportistaId: "" // Se llenar√° cuando alguien acepte
                });

                window.location.href = "subasta.html";
            } catch (error) {
                alert("Error al publicar: " + error.message);
                btn.disabled = false;
                spin.classList.add('hidden');
            }
        };
    </script>
</body>
</html>

